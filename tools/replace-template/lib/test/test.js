'use strict';

var _ = require('underscore');
var extend = _.extend;

var child = require('child_process');
var mkdirp = require('mkdirp');
var fs = require('fs');
var yaml = require('js-yaml');

var manifest = {
  applications: [{
    name: 'abacus-usage-accumulator',
    host: 'abacus-usage-accumulator',
    path: '.cfpack/app.zip',
    instances: 1,
    memory: '512M',
    disk_quota: '512M',
    env: {
      CONF: 'default',
      DEBUG: 'e-abacus-*',
      DBCLIENT: 'abacus-mongoclient',
      AGGREGATOR: 'abacus-usage-aggregator',
      PROVISIONING: 'abacus-provisioning-plugin',
      ACCOUNT: 'abacus-account-plugin',
      EUREKA: 'abacus-eureka-plugin',
      NODE_MODULES_CACHE: false,
      SLACK: '5D',
      SECURED: true
    }
  }]
};

var createManifestContent = function createManifestContent(testEnv) {
  var content = extend({}, manifest);

  var env = content.applications[0].env;
  content.applications[0].env = extend(env, testEnv);

  return yaml.dump(content);
};

var templateContent = createManifestContent({
  TEST_VARIABLE: '$TEST_VARIABLE',
  ANOTHER_TEST_VARIABLE: '$ANOTHER_TEST_VARIABLE'
});
var expectedManifestContent = createManifestContent({
  TEST_VARIABLE: 'value1',
  ANOTHER_TEST_VARIABLE: 'value2'
});

var credentialsContent = '---\n' + 'test-variable: value1\n' + 'another-test-variable: value2';

var replaceTemplateRoot = __dirname + '/../..';

var createTemporaryFiles = function createTemporaryFiles(tempDir, tempTemplateFile, tempCredentailsFile, done) {
  mkdirp(tempDir, function (err) {
    expect(err).to.equal(null);
    fs.writeFile(tempTemplateFile, templateContent, function (err) {
      expect(err).to.equal(null);
      fs.writeFile(tempCredentailsFile, credentialsContent, function (err) {
        expect(err).to.equal(null);
        done();
      });
    });
  });
};

var deleteFolderRecursive = function deleteFolderRecursive(path) {
  if (fs.existsSync(path)) {
    fs.readdirSync(path).forEach(function (file) {
      var curPath = path + '/' + file;
      if (fs.lstatSync(curPath).isDirectory()) deleteFolderRecursive(curPath);else fs.unlinkSync(curPath);
    });
    fs.rmdirSync(path);
  }
};

var runScript = function runScript(abacusConfigDir, credentialsFile, environment, done) {
  var args = [];
  if (abacusConfigDir) args.push(abacusConfigDir);
  if (credentialsFile) args.push(credentialsFile);

  var replaceTemplate = child.spawn('./replace-template', args, {
    cwd: replaceTemplateRoot,
    env: extend(process.env, environment)
  });

  replaceTemplate.stdout.on('data', function (data) {
    return process.stdout.write(data);
  });
  replaceTemplate.stderr.on('data', function (data) {
    return process.stderr.write(data);
  });

  replaceTemplate.on('exit', function (code) {
    done(code);
  });
};

var checkManifest = function checkManifest(tempManifestFile, expectedContent, done) {
  fs.readFile(tempManifestFile, 'utf8', function (err, content) {
    expect(err).to.equal(null);
    expect(content).to.equal(expectedContent);

    done();
  });
};

describe('replace-templates', function () {
  var tempConfigDir = replaceTemplateRoot + '/abacus-config';
  var tempWorkingDir = tempConfigDir + '/lib/aggregation/accumulator';
  var tempTemplateFile = tempWorkingDir + '/manifest.yml.template';
  var tempManifestFile = tempWorkingDir + '/manifest.yml';
  var tempCredentialsFile = tempWorkingDir + '/credentials.yml';

  beforeEach(function (done) {
    createTemporaryFiles(tempWorkingDir, tempTemplateFile, tempCredentialsFile, done);
  });

  afterEach(function () {
    deleteFolderRecursive(tempConfigDir);
  });

  context('when using environment variables', function () {
    beforeEach(function (done) {
      runScript(tempConfigDir, undefined, {
        TEST_VARIABLE: 'value1',
        ANOTHER_TEST_VARIABLE: 'value2'
      }, function (code) {
        expect(code).to.equal(0);
        done();
      });
    });

    it('replaces all placeholders in template', function (done) {
      checkManifest(tempManifestFile, expectedManifestContent, done);
    });
  });

  context('when using credentials file', function () {
    beforeEach(function (done) {
      runScript(tempConfigDir, tempCredentialsFile, undefined, function (code) {
        expect(code).to.equal(0);
        done();
      });
    });

    it('replaces all placeholders in template', function (done) {
      checkManifest(tempManifestFile, expectedManifestContent, done);
    });
  });

  context('with both credentials file and environment', function () {
    beforeEach(function (done) {
      runScript(tempConfigDir, tempCredentialsFile, {
        TEST_VARIABLE: 'invalid_value1',
        ANOTHER_TEST_VARIABLE: 'invalid_value2'
      }, function (code) {
        expect(code).to.equal(0);
        done();
      });
    });

    it('replaces all placeholders using credentials file', function (done) {
      checkManifest(tempManifestFile, expectedManifestContent, done);
    });
  });

  context('without abacus-config', function () {
    context('without credentials', function () {
      it('errors', function (done) {
        runScript(undefined, undefined, undefined, function (code) {
          expect(code).to.equal(1);
          done();
        });
      });
    });

    context('with credentials', function () {
      it('errors', function (done) {
        runScript(undefined, tempCredentialsFile, undefined, function (code) {
          expect(code).to.equal(1);
          done();
        });
      });
    });
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90ZXN0L3Rlc3QuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJleHRlbmQiLCJjaGlsZCIsIm1rZGlycCIsImZzIiwieWFtbCIsIm1hbmlmZXN0IiwiYXBwbGljYXRpb25zIiwibmFtZSIsImhvc3QiLCJwYXRoIiwiaW5zdGFuY2VzIiwibWVtb3J5IiwiZGlza19xdW90YSIsImVudiIsIkNPTkYiLCJERUJVRyIsIkRCQ0xJRU5UIiwiQUdHUkVHQVRPUiIsIlBST1ZJU0lPTklORyIsIkFDQ09VTlQiLCJFVVJFS0EiLCJOT0RFX01PRFVMRVNfQ0FDSEUiLCJTTEFDSyIsIlNFQ1VSRUQiLCJjcmVhdGVNYW5pZmVzdENvbnRlbnQiLCJ0ZXN0RW52IiwiY29udGVudCIsImR1bXAiLCJ0ZW1wbGF0ZUNvbnRlbnQiLCJURVNUX1ZBUklBQkxFIiwiQU5PVEhFUl9URVNUX1ZBUklBQkxFIiwiZXhwZWN0ZWRNYW5pZmVzdENvbnRlbnQiLCJjcmVkZW50aWFsc0NvbnRlbnQiLCJyZXBsYWNlVGVtcGxhdGVSb290IiwiX19kaXJuYW1lIiwiY3JlYXRlVGVtcG9yYXJ5RmlsZXMiLCJ0ZW1wRGlyIiwidGVtcFRlbXBsYXRlRmlsZSIsInRlbXBDcmVkZW50YWlsc0ZpbGUiLCJkb25lIiwiZXJyIiwiZXhwZWN0IiwidG8iLCJlcXVhbCIsIndyaXRlRmlsZSIsImRlbGV0ZUZvbGRlclJlY3Vyc2l2ZSIsImV4aXN0c1N5bmMiLCJyZWFkZGlyU3luYyIsImZvckVhY2giLCJmaWxlIiwiY3VyUGF0aCIsImxzdGF0U3luYyIsImlzRGlyZWN0b3J5IiwidW5saW5rU3luYyIsInJtZGlyU3luYyIsInJ1blNjcmlwdCIsImFiYWN1c0NvbmZpZ0RpciIsImNyZWRlbnRpYWxzRmlsZSIsImVudmlyb25tZW50IiwiYXJncyIsInB1c2giLCJyZXBsYWNlVGVtcGxhdGUiLCJzcGF3biIsImN3ZCIsInByb2Nlc3MiLCJzdGRvdXQiLCJvbiIsImRhdGEiLCJ3cml0ZSIsInN0ZGVyciIsImNvZGUiLCJjaGVja01hbmlmZXN0IiwidGVtcE1hbmlmZXN0RmlsZSIsImV4cGVjdGVkQ29udGVudCIsInJlYWRGaWxlIiwiZGVzY3JpYmUiLCJ0ZW1wQ29uZmlnRGlyIiwidGVtcFdvcmtpbmdEaXIiLCJ0ZW1wQ3JlZGVudGlhbHNGaWxlIiwiYmVmb3JlRWFjaCIsImFmdGVyRWFjaCIsImNvbnRleHQiLCJ1bmRlZmluZWQiLCJpdCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsSUFBSUMsUUFBUSxZQUFSLENBQVY7QUFDQSxJQUFNQyxTQUFTRixFQUFFRSxNQUFqQjs7QUFFQSxJQUFNQyxRQUFRRixRQUFRLGVBQVIsQ0FBZDtBQUNBLElBQU1HLFNBQVNILFFBQVEsUUFBUixDQUFmO0FBQ0EsSUFBTUksS0FBS0osUUFBUSxJQUFSLENBQVg7QUFDQSxJQUFNSyxPQUFPTCxRQUFRLFNBQVIsQ0FBYjs7QUFFQSxJQUFNTSxXQUFXO0FBQ2ZDLGdCQUFjLENBQUM7QUFDYkMsVUFBTSwwQkFETztBQUViQyxVQUFNLDBCQUZPO0FBR2JDLFVBQU0saUJBSE87QUFJYkMsZUFBVyxDQUpFO0FBS2JDLFlBQVEsTUFMSztBQU1iQyxnQkFBWSxNQU5DO0FBT2JDLFNBQUs7QUFDSEMsWUFBTSxTQURIO0FBRUhDLGFBQU8sWUFGSjtBQUdIQyxnQkFBVSxvQkFIUDtBQUlIQyxrQkFBWSx5QkFKVDtBQUtIQyxvQkFBYyw0QkFMWDtBQU1IQyxlQUFTLHVCQU5OO0FBT0hDLGNBQVEsc0JBUEw7QUFRSEMsMEJBQW9CLEtBUmpCO0FBU0hDLGFBQU8sSUFUSjtBQVVIQyxlQUFTO0FBVk47QUFQUSxHQUFEO0FBREMsQ0FBakI7O0FBdUJBLElBQU1DLHdCQUF3QixTQUF4QkEscUJBQXdCLENBQUNDLE9BQUQsRUFBYTtBQUN6QyxNQUFNQyxVQUFVMUIsT0FBTyxFQUFQLEVBQVdLLFFBQVgsQ0FBaEI7O0FBRUEsTUFBTVEsTUFBTWEsUUFBUXBCLFlBQVIsQ0FBcUIsQ0FBckIsRUFBd0JPLEdBQXBDO0FBQ0FhLFVB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QUNyQ0EsWUFBUSxxQkFBUixFQUErQixZQUFNO0FBQ25DRSxTQUFHLFFBQUgsRUFBYSxVQUFDNUMsSUFBRCxFQUFVO0FBQ3JCZ0Isa0JBQVUyQixTQUFWLEVBQXFCQSxTQUFyQixFQUFnQ0EsU0FBaEMsRUFBMkMsVUFBQ1osSUFBRCxFQUFVO0FBQ25EN0IsaUJBQU82QixJQUFQLEVBQWE1QixFQUFiLENBQWdCQyxLQUFoQixDQUFzQixDQUF0QjtBQUNBSjtBQUNELFNBSEQ7QUFJRCxPQUxEO0FBTUQsS0FQRDs7QUFTQTBDLFlBQVEsa0JBQVIsRUFBNEIsWUFBTTtBQUNoQ0UsU0FBRyxRQUFILEVBQWEsVUFBQzVDLElBQUQsRUFBVTtBQUNyQmdCLGtCQUFVMkIsU0FBVixFQUFxQkosbUJBQXJCLEVBQTBDSSxTQUExQyxFQUFxRCxVQUFDWixJQUFELEVBQVU7QUFDN0Q3QixpQkFBTzZCLElBQVAsRUFBYTVCLEVBQWIsQ0FBZ0JDLEtBQWhCLENBQXNCLENBQXRCO0FBQ0FKO0FBQ0QsU0FIRDtBQUlELE9BTEQ7QUFNRCxLQVBEO0FBUUQsR0FsQkQ7QUFxQkQsQ0FsRkQiLCJmaWxlIjoidGVzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTtcbmNvbnN0IGV4dGVuZCA9IF8uZXh0ZW5kO1xuXG5jb25zdCBjaGlsZCA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTtcbmNvbnN0IG1rZGlycCA9IHJlcXVpcmUoJ21rZGlycCcpO1xuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuY29uc3QgeWFtbCA9IHJlcXVpcmUoJ2pzLXlhbWwnKTtcblxuY29uc3QgbWFuaWZlc3QgPSB7XG4gIGFwcGxpY2F0aW9uczogW3tcbiAgICBuYW1lOiAnYWJhY3VzLXVzYWdlLWFjY3VtdWxhdG9yJyxcbiAgICBob3N0OiAnYWJhY3VzLXVzYWdlLWFjY3VtdWxhdG9yJyxcbiAgICBwYXRoOiAnLmNmcGFjay9hcHAuemlwJyxcbiAgICBpbnN0YW5jZXM6IDEsXG4gICAgbWVtb3J5OiAnNTEyTScsXG4gICAgZGlza19xdW90YTogJzUxMk0nLFxuICAgIGVudjoge1xuICAgICAgQ09ORjogJ2RlZmF1bHQnLFxuICAgICAgREVCVUc6ICdlLWFiYWN1cy0qJyxcbiAgICAgIERCQ0xJRU5UOiAnYWJhY3VzLW1vbmdvY2xpZW50JyxcbiAgICAgIEFHR1JFR0FUT1I6ICdhYmFjdXMtdXNhZ2UtYWdncmVnYXRvcicsXG4gICAgICBQUk9WSVNJT05JTkc6ICdhYmFjdXMtcHJvdmlzaW9uaW5nLXBsdWdpbicsXG4gICAgICBBQ0NPVU5UOiAnYWJhY3VzLWFjY291bnQtcGx1Z2luJyxcbiAgICAgIEVVUkVLQTogJ2FiYWN1cy1ldXJla2EtcGx1Z2luJyxcbiAgICAgIE5PREVfTU9EVUxFU19DQUNIRTogZmFsc2UsXG4gICAgICBTTEFDSzogJzVEJyxcbiAgICAgIFNFQ1VSRUQ6IHRydWVcbiAgICB9XG4gIH1dXG59O1xuXG5jb25zdCBjcmVhdGVNYW5pZmVzdENvbnRlbnQgPSAodGVzdEVudikgPT4ge1xuICBjb25zdCBjb250ZW50ID0gZXh0ZW5kKHt9LCBtYW5pZmVzdCk7XG5cbiAgY29uc3QgZW52ID0gY29udGVudC5hcHBsaWNhdGlvbnNbMF0uZW52O1xuICBjb250ZW50LmFwcGxpY2F0aW9uc1swXS5lbnYgPSBleHRlbmQoZW52LCB0ZXN0RW52KTtcblxuICByZXR1cm4geWFtbC5kdW1wKGNvbnRlbnQpO1xufTtcblxuY29uc3QgdGVtcGxhdGVDb250ZW50ID0gY3JlYXRlTWFuaWZlc3RDb250ZW50KHtcbiAgVEVTVF9WQVJJQUJMRTogJyRURVNUX1ZBUklBQkxFJyxcbiAgQU5PVEhFUl9URVNUX1ZBUklBQkxFOiAnJEFOT1RIRVJfVEVTVF9WQVJJQUJMRSdcbn0pO1xuY29uc3QgZXhwZWN0ZWRNYW5pZmVzdENvbnRlbnQgPSBjcmVhdGVNYW5pZmVzdENvbnRlbnQoe1xuICBURVNUX1ZBUklBQkxFOiAndmFsdWUxJyxcbiAgQU5PVEhFUl9URVNUX1ZBUklBQkxFOiAndmFsdWUyJ1xufSk7XG5cbmNvbnN0IGNyZWRlbnRpYWxzQ29udGVudCA9ICctLS1cXG4nICtcbiAgJ3Rlc3QtdmFyaWFibGU6IHZhbHVlMVxcbicgK1xuICAnYW5vdGhlci10ZXN0LXZhcmlhYmxlOiB2YWx1ZTInO1xuXG5jb25zdCByZXBsYWNlVGVtcGxhdGVSb290ID0gX19kaXJuYW1lICsgJy8uLi8uLic7XG5cbmNvbnN0IGNyZWF0ZVRlbXBvcmFyeUZpbGVzID0gKHRlbXBEaXIsIHRlbXBUZW1wbGF0ZUZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wQ3JlZGVudGFpbHNGaWxlLCBkb25lKSA9PiB7XG4gIG1rZGlycCh0ZW1wRGlyLCAoZXJyKSA9PiB7XG4gICAgZXhwZWN0KGVycikudG8uZXF1YWwobnVsbCk7XG4gICAgZnMud3JpdGVGaWxlKHRlbXBUZW1wbGF0ZUZpbGUsIHRlbXBsYXRlQ29udGVudCwgKGVycikgPT4ge1xuICAgICAgZXhwZWN0KGVycikudG8uZXF1YWwobnVsbCk7XG4gICAgICBmcy53cml0ZUZpbGUodGVtcENyZWRlbnRhaWxzRmlsZSwgY3JlZGVudGlhbHNDb250ZW50LCAoZXJyKSA9PiB7XG4gICAgICAgIGV4cGVjdChlcnIpLnRvLmVxdWFsKG51bGwpO1xuICAgICAgICBkb25lKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59O1xuXG5jb25zdCBkZWxldGVGb2xkZXJSZWN1cnNpdmUgPSAocGF0aCkgPT4ge1xuICBpZihmcy5leGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgZnMucmVhZGRpclN5bmMocGF0aCkuZm9yRWFjaCgoZmlsZSkgPT4ge1xuICAgICAgY29uc3QgY3VyUGF0aCA9IHBhdGggKyAnLycgKyBmaWxlO1xuICAgICAgaWYoZnMubHN0YXRTeW5jKGN1clBhdGgpLmlzRGlyZWN0b3J5KCkpXG4gICAgICAgIGRlbGV0ZUZvbGRlclJlY3Vyc2l2ZShjdXJQYXRoKTtcbiAgICAgIGVsc2VcbiAgICAgICAgZnMudW5saW5rU3luYyhjdXJQYXRoKTtcbiAgICB9KTtcbiAgICBmcy5ybWRpclN5bmMocGF0aCk7XG4gIH1cbn07XG5cbmNvbnN0IHJ1blNjcmlwdCA9IChhYmFjdXNDb25maWdEaXIsIGNyZWRlbnRpYWxzRmlsZSwgZW52aXJvbm1lbnQsIGRvbmUpID0+IHtcbiAgY29uc3QgYXJncyA9IFtdO1xuICBpZiAoYWJhY3VzQ29uZmlnRGlyKVxuICAgIGFyZ3MucHVzaChhYmFjdXNDb25maWdEaXIpO1xuICBpZiAoY3JlZGVudGlhbHNGaWxlKVxuICAgIGFyZ3MucHVzaChjcmVkZW50aWFsc0ZpbGUpO1xuXG4gIGNvbnN0IHJlcGxhY2VUZW1wbGF0ZSA9IGNoaWxkLnNwYXduKCcuL3JlcGxhY2UtdGVtcGxhdGUnLCBhcmdzLCB7XG4gICAgY3dkOiByZXBsYWNlVGVtcGxhdGVSb290LFxuICAgIGVudjogZXh0ZW5kKHByb2Nlc3MuZW52LCBlbnZpcm9ubWVudClcbiAgfSk7XG5cbiAgcmVwbGFjZVRlbXBsYXRlLnN0ZG91dC5vbignZGF0YScsIChkYXRhKSA9PiBwcm9jZXNzLnN0ZG91dC53cml0ZShkYXRhKSk7XG4gIHJlcGxhY2VUZW1wbGF0ZS5zdGRlcnIub24oJ2RhdGEnLCAoZGF0YSkgPT4gcHJvY2Vzcy5zdGRlcnIud3JpdGUoZGF0YSkpO1xuXG4gIHJlcGxhY2VUZW1wbGF0ZS5vbignZXhpdCcsIChjb2RlKSA9PiB7XG4gICAgZG9uZShjb2RlKTtcbiAgfSk7XG59O1xuXG5jb25zdCBjaGVja01hbmlmZXN0ID0gKHRlbXBNYW5pZmVzdEZpbGUsIGV4cGVjdGVkQ29udGVudCwgZG9uZSkgPT4ge1xuICBmcy5yZWFkRmlsZSh0ZW1wTWFuaWZlc3RGaWxlLCAndXRmOCcsIChlcnIsIGNvbnRlbnQpID0+IHtcbiAgICBleHBlY3QoZXJyKS50by5lcXVhbChudWxsKTtcbiAgICBleHBlY3QoY29udGVudCkudG8uZXF1YWwoZXhwZWN0ZWRDb250ZW50KTtcblxuICAgIGRvbmUoKTtcbiAgfSk7XG59O1xuXG5kZXNjcmliZSgncmVwbGFjZS10ZW1wbGF0ZXMnLCAoKSA9PiB7XG4gIGNvbnN0IHRlbXBDb25maWdEaXIgPSByZXBsYWNlVGVtcGxhdGVSb290ICsgJy9hYmFjdXMtY29uZmlnJztcbiAgY29uc3QgdGVtcFdvcmtpbmdEaXIgPSB0ZW1wQ29uZmlnRGlyICsgJy9saWIvYWdncmVnYXRpb24vYWNjdW11bGF0b3InO1xuICBjb25zdCB0ZW1wVGVtcGxhdGVGaWxlID0gdGVtcFdvcmtpbmdEaXIgKyAnL21hbmlmZXN0LnltbC50ZW1wbGF0ZSc7XG4gIGNvbnN0IHRlbXBNYW5pZmVzdEZpbGUgPSB0ZW1wV29ya2luZ0RpciArICcvbWFuaWZlc3QueW1sJztcbiAgY29uc3QgdGVtcENyZWRlbnRpYWxzRmlsZSA9IHRlbXBXb3JraW5nRGlyICsgJy9jcmVkZW50aWFscy55bWwnO1xuXG4gIGJlZm9yZUVhY2goKGRvbmUpID0+IHtcbiAgICBjcmVhdGVUZW1wb3JhcnlGaWxlcyh0ZW1wV29ya2luZ0RpciwgdGVtcFRlbXBsYXRlRmlsZSxcbiAgICAgIHRlbXBDcmVkZW50aWFsc0ZpbGUsIGRvbmUpO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGRlbGV0ZUZvbGRlclJlY3Vyc2l2ZSh0ZW1wQ29uZmlnRGlyKTtcbiAgfSk7XG5cbiAgY29udGV4dCgnd2hlbiB1c2luZyBlbnZpcm9ubWVudCB2YXJpYWJsZXMnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoZG9uZSkgPT4ge1xuICAgICAgcnVuU2NyaXB0KHRlbXBDb25maWdEaXIsIHVuZGVmaW5lZCwge1xuICAgICAgICBURVNUX1ZBUklBQkxFOiAndmFsdWUxJyxcbiAgICAgICAgQU5PVEhFUl9URVNUX1ZBUklBQkxFOiAndmFsdWUyJ1xuICAgICAgfSwgKGNvZGUpID0+IHtcbiAgICAgICAgZXhwZWN0KGNvZGUpLnRvLmVxdWFsKDApO1xuICAgICAgICBkb25lKCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdyZXBsYWNlcyBhbGwgcGxhY2Vob2xkZXJzIGluIHRlbXBsYXRlJywgKGRvbmUpID0+IHtcbiAgICAgIGNoZWNrTWFuaWZlc3QodGVtcE1hbmlmZXN0RmlsZSwgZXhwZWN0ZWRNYW5pZmVzdENvbnRlbnQsIGRvbmUpO1xuICAgIH0pO1xuICB9KTtcblxuICBjb250ZXh0KCd3aGVuIHVzaW5nIGNyZWRlbnRpYWxzIGZpbGUnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoZG9uZSkgPT4ge1xuICAgICAgcnVuU2NyaXB0KHRlbXBDb25maWdEaXIsIHRlbXBDcmVkZW50aWFsc0ZpbGUsIHVuZGVmaW5lZCwgKGNvZGUpID0+IHtcbiAgICAgICAgZXhwZWN0KGNvZGUpLnRvLmVxdWFsKDApO1xuICAgICAgICBkb25lKCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdyZXBsYWNlcyBhbGwgcGxhY2Vob2xkZXJzIGluIHRlbXBsYXRlJywgKGRvbmUpID0+IHtcbiAgICAgIGNoZWNrTWFuaWZlc3QodGVtcE1hbmlmZXN0RmlsZSwgZXhwZWN0ZWRNYW5pZmVzdENvbnRlbnQsIGRvbmUpO1xuICAgIH0pO1xuICB9KTtcblxuICBjb250ZXh0KCd3aXRoIGJvdGggY3JlZGVudGlhbHMgZmlsZSBhbmQgZW52aXJvbm1lbnQnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoZG9uZSkgPT4ge1xuICAgICAgcnVuU2NyaXB0KHRlbXBDb25maWdEaXIsIHRlbXBDcmVkZW50aWFsc0ZpbGUsIHtcbiAgICAgICAgVEVTVF9WQVJJQUJMRTogJ2ludmFsaWRfdmFsdWUxJyxcbiAgICAgICAgQU5PVEhFUl9URVNUX1ZBUklBQkxFOiAnaW52YWxpZF92YWx1ZTInXG4gICAgICB9LCAoY29kZSkgPT4ge1xuICAgICAgICBleHBlY3QoY29kZSkudG8uZXF1YWwoMCk7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3JlcGxhY2VzIGFsbCBwbGFjZWhvbGRlcnMgdXNpbmcgY3JlZGVudGlhbHMgZmlsZScsIChkb25lKSA9PiB7XG4gICAgICBjaGVja01hbmlmZXN0KHRlbXBNYW5pZmVzdEZpbGUsIGV4cGVjdGVkTWFuaWZlc3RDb250ZW50LCBkb25lKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgY29udGV4dCgnd2l0aG91dCBhYmFjdXMtY29uZmlnJywgKCkgPT4ge1xuICAgIGNvbnRleHQoJ3dpdGhvdXQgY3JlZGVudGlhbHMnLCAoKSA9PiB7XG4gICAgICBpdCgnZXJyb3JzJywgKGRvbmUpID0+IHtcbiAgICAgICAgcnVuU2NyaXB0KHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIChjb2RlKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KGNvZGUpLnRvLmVxdWFsKDEpO1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGNvbnRleHQoJ3dpdGggY3JlZGVudGlhbHMnLCAoKSA9PiB7XG4gICAgICBpdCgnZXJyb3JzJywgKGRvbmUpID0+IHtcbiAgICAgICAgcnVuU2NyaXB0KHVuZGVmaW5lZCwgdGVtcENyZWRlbnRpYWxzRmlsZSwgdW5kZWZpbmVkLCAoY29kZSkgPT4ge1xuICAgICAgICAgIGV4cGVjdChjb2RlKS50by5lcXVhbCgxKTtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG5cbn0pO1xuIl19