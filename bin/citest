#!/bin/bash

set -e

case "$CI_TEST" in
  integration)
    # Based on default limits in throttle and batch processing and
    # integration test matrix, we would need 2197 (= 13 * 13 * 13)
    # usage submissions to get above 90 percent regression coverage

    yarn run integration
    ;;

  extended)
    # Run yarn process-usage-smoke test
    yarn start
    sleep 3s
    yarn run process-usage-smoke
    yarn stop

    # Run demo and yarn process-usage-smoke tests without security
    yarn start
    sleep 3s
    yarn run demo
    yarn run process-usage-smoke
    yarn stop

    # Run demo test with the smalldb config
    yarn start smalldb
    sleep 3s
    yarn run demo
    yarn stop
    ;;

  performance)
    # Run performance test without security
    export ORGS=4
    export INSTANCES=4
    export USAGE_DOCS=4
    yarn start
    sleep 3s
    yarn run performance
    yarn stop

    # Run performance test with security
    export SECURED=true
    export JWTKEY=encode
    export JWTALGO=HS256
    export ORGS=4
    export INSTANCES=4
    export USAGE_DOCS=4
    yarn start
    sleep 10s
    yarn run performance
    yarn stop

    # Test for concurrency
    export SECURED=false
    export ORGS=1
    export INSTANCES=8
    export USAGE_DOCS=8
    yarn start small
    sleep 10s
    yarn run performance
    yarn stop
    ;;

  *)
    echo "Unknown test $CI_SUITE"
    ;;

esac
